<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart QB Pro - Full Enterprise Solution</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { 
            --gold: #fbbf24; --gold-dark: #d97706;
            --bg: #020617; --sidebar: #0f172a; --card: #1e293b;
            --accent: #10b981; --text: #f8fafc;
        }

        body { font-family: 'Hind Siliguri', sans-serif; background: var(--bg); margin: 0; display: flex; color: var(--text); height: 100vh; overflow: hidden; }

        /* --- Sidebar & Desktop Layout --- */
        .sidebar { width: 260px; background: var(--sidebar); padding: 25px; display: flex; flex-direction: column; border-right: 1px solid #334155; transition: 0.3s; flex-shrink: 0; }
        .sidebar h2 { color: var(--gold); text-align: center; margin-bottom: 25px; font-size: 22px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        
        .nav-link { padding: 12px 18px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #94a3b8; transition: 0.3s; margin-bottom: 8px; font-weight: 500; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-link.active { background: var(--gold); color: #000; font-weight: 700; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }

        .main-content { flex: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top right, #0f172a, #020617); }
        .card { background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid #334155; margin-bottom: 25px; }

        /* --- Mobile View Responsive Fix (যাতে ড্যাশবোর্ড না ভাঙে) --- */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { 
                width: 100%; height: auto; flex-direction: row; flex-wrap: wrap; 
                justify-content: center; position: sticky; top: 0; z-index: 1000; 
                border-right: none; border-bottom: 1px solid #334155; padding: 10px;
            }
            .sidebar h2, .sidebar span, #authStatusText { display: none; }
            .nav-link { padding: 10px; margin: 5px; border-radius: 10px; }
            .main-content { padding: 20px; }
            .footer-action { bottom: 90px; right: 20px; }
        }

        /* --- UI Elements --- */
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #334155; border-radius: 10px; background: #0f172a; color: white; margin-bottom: 15px; font-family: inherit; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--gold); }
        .btn { padding: 12px 25px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; background: var(--gold); color: #000; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn:hover { background: var(--gold-dark); transform: translateY(-2px); }

        .q-card { background: #1e293b; padding: 25px; border-radius: 18px; border: 1px solid #334155; margin-bottom: 20px; position: relative; }
        .badge { padding: 4px 12px; border-radius: 8px; font-size: 12px; background: #020617; color: var(--gold); margin-right: 8px; border: 1px solid #334155; }
        
        #loginOverlay { position: fixed; inset: 0; background: rgba(2,6,23,0.98); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .footer-action { position: fixed; bottom: 30px; right: 30px; background: #fff; color: #000; padding: 15px 35px; border-radius: 50px; font-weight: 800; cursor: pointer; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div style="width: 320px; text-align: center; background: var(--sidebar); padding: 40px; border-radius: 25px; border: 1px solid var(--gold);">
        <i class="fas fa-lock" style="font-size: 50px; color: var(--gold); margin-bottom: 20px;"></i>
        <h2 style="margin-bottom: 20px;">অ্যাডমিন এক্সেস</h2>
        <input type="email" id="loginEmail" placeholder="ইমেইল">
        <input type="password" id="loginPass" placeholder="পাসওয়ার্ড">
        <button class="btn" style="width: 100%; justify-content: center;" onclick="handleLogin()">লগইন</button>
        <p onclick="closeLogin()" style="margin-top: 15px; cursor: pointer; color: #94a3b8;">বাতিল</p>
    </div>
</div>

<div class="sidebar">
    <h2>Smart QB Pro</h2>
    <div class="nav-link active" id="homeBtn" onclick="showTab('home')"><i class="fas fa-chart-pie"></i> <span>ড্যাশবোর্ড</span></div>
    <div class="nav-link" id="userBtn" onclick="showTab('user')"><i class="fas fa-list-ul"></i> <span>প্রশ্ন ব্যাংক</span></div>
    <div class="nav-link" id="savedBtn" onclick="showTab('saved')"><i class="fas fa-star"></i> <span>সংরক্ষিত</span></div>
    
    <div class="nav-link" id="adminBtn" style="display:none;" onclick="showTab('admin')"><i class="fas fa-plus-square"></i> <span>নতুন এন্ট্রি</span></div>
    
    <div style="margin-top: auto; border-top: 1px solid #334155; padding-top: 20px;">
        <div id="loginNav" class="nav-link" onclick="openLogin()"><i class="fas fa-user-shield"></i> <span>অ্যাডমিন লগইন</span></div>
        <div id="logoutNav" class="nav-link" onclick="handleLogout()" style="display:none; color: #f87171;"><i class="fas fa-power-off"></i> <span>লগআউট</span></div>
    </div>
</div>

<div class="main-content">
    <div id="homeTab">
        <h1 style="font-weight: 700;">মেইন ড্যাশবোর্ড</h1>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px;">
            <div class="card" style="border-left: 5px solid var(--gold);"><h3>মোট প্রশ্ন সংখ্যা</h3><h2 id="totalQ" style="font-size: 40px; margin: 10px 0;">0</h2></div>
            <div class="card" style="border-left: 5px solid var(--accent);"><h3>সংরক্ষিত প্রশ্ন</h3><h2 id="savedCount" style="font-size: 40px; margin: 10px 0;">0</h2></div>
        </div>
    </div>

    <div id="adminTab" style="display:none;">
        <div class="card">
            <h2 style="color: var(--gold); margin-top: 0;"><i class="fas fa-plus-circle"></i> নতুন প্রশ্ন যুক্ত করুন</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <select id="classSelect" onchange="autoLoadSubjects()">
                    <option value="">শ্রেণি নির্বাচন করুন</option>
                    <option value="Play">প্লে (Play)</option>
                    <option value="Nursery">নার্সারি</option>
                    <option value="KG">কেজি</option>
                    <option value="One">প্রথম শ্রেণি</option>
                    <option value="Five">পঞ্চম শ্রেণি</option>
                    <option value="Six">ষষ্ঠ শ্রেণি</option>
                    <option value="Ten">দশম শ্রেণি</option>
                    <option value="Eleven">একাদশ শ্রেণি</option>
                </select>
                <select id="subjectSelect"><option value="">বিষয় নির্বাচন</option></select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <input type="text" id="chapterInput" placeholder="অধ্যায়ের নাম">
                <input type="text" id="exerciseInput" placeholder="অনুশীলনী (ঐচ্ছিক)">
            </div>
            <textarea id="mainInput" rows="5" placeholder="এখানে প্রশ্নটি লিখুন..."></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <input type="number" id="marks" placeholder="নম্বর" style="width: 100px; margin: 0;">
                <button class="btn" onclick="saveData()"><i class="fas fa-save"></i> ডেটাবেসে সেভ করুন</button>
            </div>
        </div>
    </div>

    <div id="userTab" style="display:none;">
        <h1 style="color: var(--gold);">প্রশ্ন ভাণ্ডার</h1>
        <div id="listArea">লোড হচ্ছে...</div>
    </div>

    <div id="savedTab" style="display:none;">
        <h1>আপনার সংরক্ষিত প্রশ্ন</h1>
        <div id="savedArea"></div>
    </div>
</div>

<div class="footer-action" id="footer" onclick="generatePDF()">
    <i class="fas fa-file-pdf"></i> PDF ডাউনলোড (<span id="count">0</span>)
</div>

<script>
    // --- FULL SUBJECT DATABASE ---
    const subjectDB = {
        "Play": ["বাংলা", "English", "গণিত"],
        "Nursery": ["বাংলা", "English", "গণিত", "ছড়া"],
        "KG": ["বাংলা", "English", "গণিত", "সাধারণ জ্ঞান"],
        "One": ["বাংলা", "English", "গণিত"],
        "Five": ["বাংলা", "English", "গণিত", "বিজ্ঞান", "বিজিএস", "ধর্ম"],
        "Six": ["বাংলা", "English", "গণিত", "বিজ্ঞান", "ইতিহাস", "ডিজিটাল প্রযুক্তি", "জীবন ও জীবিকা"],
        "Ten": ["বাংলা", "English", "গণিত", "পদার্থবিজ্ঞান", "রসায়ন", "উচ্চতর গণিত", "জীববিজ্ঞান", "ICT"],
        "Eleven": ["বাংলা ১ম", "English", "ICT", "পদার্থবিজ্ঞান ১ম", "রসায়ন ১ম", "উচ্চতর গণিত ১ম", "জীববিজ্ঞান ১ম"]
    };

    // Firebase Config (Original)
    const firebaseConfig = {
        apiKey: "AIzaSyCmlyWM3zRYURL_saQgpt4-Ke5d5aBtgzo",
        authDomain: "smart-qb.firebaseapp.com",
        databaseURL: "https://smart-qb-default-rtdb.firebaseio.com",
        projectId: "smart-qb",
        storageBucket: "smart-qb.firebasestorage.app",
        messagingSenderId: "890982420266",
        appId: "1:890982420266:web:6b94f3980ef36d24059853"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('questions_v2');
    const auth = firebase.auth();

    let allData = [];
    let savedIds = JSON.parse(localStorage.getItem('saved_v2')) || [];

    // --- AUTHENTICATION ---
    function openLogin() { document.getElementById('loginOverlay').style.display = 'flex'; }
    function closeLogin() { document.getElementById('loginOverlay').style.display = 'none'; }

    function handleLogin() {
        const e = document.getElementById('loginEmail').value;
        const p = document.getElementById('loginPass').value;
        auth.signInWithEmailAndPassword(e, p)
            .then(() => { closeLogin(); alert("লগইন সফল হয়েছে!"); })
            .catch(() => alert("ইমেইল অথবা পাসওয়ার্ড ভুল!"));
    }

    function handleLogout() {
        auth.signOut().then(() => { alert("লগআউট হয়েছে!"); location.reload(); });
    }

    auth.onAuthStateChanged(user => {
        document.getElementById('adminBtn').style.display = user ? 'flex' : 'none';
        document.getElementById('logoutNav').style.display = user ? 'flex' : 'none';
        document.getElementById('loginNav').style.display = user ? 'none' : 'flex';
    });

    // --- CORE LOGIC ---
    function autoLoadSubjects() {
        const cls = document.getElementById('classSelect').value;
        const subBox = document.getElementById('subjectSelect');
        subBox.innerHTML = '<option value="">বিষয় নির্বাচন</option>';
        if(subjectDB[cls]) subjectDB[cls].forEach(s => subBox.innerHTML += `<option value="${s}">${s}</option>`);
    }

    db.on('value', snap => {
        const data = snap.val();
        allData = data ? Object.entries(data).map(([id, val]) => ({...val, id})) : [];
        updateUI();
    });

    function saveData() {
        if(!auth.currentUser) return alert("অ্যাডমিন লগইন প্রয়োজন!");
        const data = {
            cls: document.getElementById('classSelect').value,
            sub: document.getElementById('subjectSelect').value,
            chp: document.getElementById('chapterInput').value,
            exe: document.getElementById('exerciseInput').value,
            txt: document.getElementById('mainInput').value,
            mks: document.getElementById('marks').value,
            timestamp: Date.now()
        };
        if(!data.cls || !data.txt) return alert("শ্রেণি এবং প্রশ্ন অবশ্যই লিখুন!");
        db.push(data).then(() => { alert("সফলভাবে সেভ হয়েছে!"); resetForm(); });
    }

    function updateUI() {
        document.getElementById('totalQ').innerText = allData.length;
        document.getElementById('savedCount').innerText = savedIds.length;
        renderList('listArea', allData);
        renderList('savedArea', allData.filter(q => savedIds.includes(q.id)));
    }

    function renderList(targetId, dataArray) {
        const area = document.getElementById(targetId);
        if(!dataArray.length) { area.innerHTML = "<p style='color:#94a3b8'>কোনো প্রশ্ন পাওয়া যায়নি।</p>"; return; }
        area.innerHTML = dataArray.map(q => `
            <div class="q-card">
                <div><span class="badge">${q.cls}</span><span class="badge" style="background:var(--gold); color:#000;">${q.sub}</span></div>
                <p style="font-size:18px; margin:15px 0; line-height:1.6;">${q.txt}</p>
                <div style="display:flex; align-items:center; gap:15px;">
                    <input type="checkbox" class="q-check" value="${q.id}" onchange="updateCount()" style="width:20px; height:20px; cursor:pointer;">
                    <i class="fa${savedIds.includes(q.id)?'s':'r'} fa-star" onclick="toggleSave('${q.id}')" style="color:var(--gold); cursor:pointer; font-size:22px;"></i>
                    ${auth.currentUser ? `<i class="fas fa-trash-alt" onclick="deleteItem('${q.id}')" style="color:#f87171; cursor:pointer; margin-left:auto; font-size:18px;"></i>` : ''}
                </div>
                <small style="color:#94a3b8; display:block; margin-top:10px;">অধ্যায়: ${q.chp} | নম্বর: ${q.mks}</small>
            </div>
        `).join('');
    }

    function toggleSave(id) {
        if(savedIds.includes(id)) savedIds = savedIds.filter(i => i !== id);
        else savedIds.push(id);
        localStorage.setItem('saved_v2', JSON.stringify(savedIds));
        updateUI();
    }

    function deleteItem(id) { if(confirm("এই প্রশ্নটি ডিলিট করতে চান?")) db.child(id).remove(); }

    function showTab(t) {
        ['home', 'admin', 'user', 'saved'].forEach(id => {
            const tab = document.getElementById(id+'Tab');
            const btn = document.getElementById(id+'Btn');
            if(tab) tab.style.display = (id === t ? 'block' : 'none');
            if(btn) btn.classList.toggle('active', id === t);
        });
        document.getElementById('footer').style.display = (t === 'user' ? 'block' : 'none');
    }

    function updateCount() { document.getElementById('count').innerText = document.querySelectorAll('.q-check:checked').length; }
    function resetForm() { document.getElementById('mainInput').value = ''; document.getElementById('marks').value = ''; }

    // --- PDF EXPORT (STABLE) ---
    function generatePDF() {
        const selected = Array.from(document.querySelectorAll('.q-check:checked')).map(cb => allData.find(q => q.id === cb.value));
        if(!selected.length) return alert("কমপক্ষে একটি প্রশ্ন সিলেক্ট করুন!");

        const box = document.createElement('div');
        box.style.padding = '50px'; box.style.background = '#fff'; box.style.color = '#000'; box.style.width = '750px';
        box.innerHTML = `<h1 style="text-align:center; border-bottom: 2px solid #000; padding-bottom:10px;">Smart QB Pro - Exam Paper</h1>`;
        
        selected.forEach((q, i) => {
            box.innerHTML += `<div style="margin-bottom:25px;"><p style="font-size:20px;"><b>${i+1}. ${q.txt}</b> <span style="float:right;">[${q.mks}]</span></p></div>`;
        });

        document.body.appendChild(box);
        html2canvas(box, { scale: 2 }).then(canvas => {
            const img = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
            const width = pdf.internal.pageSize.getWidth();
            const height = (canvas.height * width) / canvas.width;
            pdf.addImage(img, 'PNG', 0, 0, width, height);
            pdf.save("Exam_Paper.pdf");
            document.body.removeChild(box);
        });
    }
</script>
</body>
</html>
